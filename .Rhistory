trait     <- readRDS("dataOriginal/FishMORPH_Traits.rds")
phylogeny <- readRDS("dataOriginal/FishMORPH_Phylogeny.rds")
traitNames <- colnames(trait)[-c(1:6)]
# Species list
list_sp <- gsub("\\.", " ", as.character(trait$Genus.species))
# Length-weight from FishBase
lgtwgt <- as.data.frame(length_weight(list_sp))
lgtwgt <- lgtwgt[!is.na(lgtwgt$a) & !is.na(lgtwgt$b), ]
# Best a, b coefficients per species
ab <- lgtwgt %>%
dplyr::group_by(Species) %>%
dplyr::slice_max(order_by = CoeffDetermination, with_ties = FALSE, na_rm = TRUE) %>%
dplyr::select(Species, a, b) %>%
dplyr::distinct()
# Additional traits from FishBase
speciesInfo <- species(list_sp) %>% data.table::data.table()
speciesInfoSub <- speciesInfo[, .(Species, Fresh, LongevityWild, Length, Weight, LTypeMaxM)]
speciesInfoSub <- unique(speciesInfoSub)
speciesInfoSub$Species <- gsub(" ", ".", speciesInfoSub$Species)
speciesInfoSub <- speciesInfoSub %>%
dplyr::mutate(
Length = ifelse(LTypeMaxM != "SL", NA, Length),
Weight2 = ifelse(
Species %in% gsub(" ", ".", rownames(ab)),
ab[gsub("\\.", " ", Species), "a"] * Length^ab[gsub("\\.", " ", Species), "b"],
NA
)
) %>%
dplyr::mutate(
Weight = ifelse(is.na(Weight) & !is.na(Weight2), Weight2, Weight)
)
# Merge FishMORPH traits with FishBase length/weight
fishTraits <- merge(
trait[, 6:15],
speciesInfoSub[, .(Species, Length, Weight)],
by.x = "Genus.species",
by.y = "Species",
all.x = TRUE
)
fishTraits <- fishTraits %>%
dplyr::mutate(dplyr::across(-Genus.species, ~ log10(.x + 1))) %>%
dplyr::rename(species = Genus.species) %>%
dplyr::mutate(species = gsub("\\.", "_", species))
spToKeep <- fishTraits %>%
dplyr::select(species) %>%
dplyr::mutate(species = gsub("_", " ", species)) %>%
dplyr::pull() %>%
rfishbase::species() %>%
data.table::as.data.table() %>%
dplyr::filter(Fresh == 1) %>%
dplyr::select(Species) %>%
dplyr::mutate(Species = gsub(" ", "_", Species)) %>%
dplyr::pull()
fishTraits <- fishTraits %>%
dplyr::filter(species %in% spToKeep)
fishTraits <- read.table("dataPrepared/Fish/fishTraitsMissing.txt")
# Pre-computed PCoA (recommended)
pcoaPhyl <- read.table(
"dataPrepared/Fish/pcoaPhylogenyFish.txt",
header = TRUE,
stringsAsFactors = FALSE
)
rownames(pcoaPhyl) <- fishTraits$species
colnames(pcoaPhyl) <- paste0("Eigen.", 1:10)
list_sp_raw <- fishTraits$species
list_sp_raw <- gsub("_", " ", list_sp_raw)
list_sp_raw <- stringr::str_squish(list_sp_raw)
# write.table(traitsAndPCOA, "dataPrepared/Fish/traitsWithPCOA.txt")
traitsAndPCOA <- read.table(
"dataPrepared/Fish/traitsWithPCOA.txt",
header = TRUE,
stringsAsFactors = FALSE
)
species_list <- unique(stringr::str_trim(traitsAndPCOA$species))
iucn_statut <- read.csv(
"dataOriginal/assessments.csv",
header = TRUE,
stringsAsFactors = FALSE
) # IUCN data 2024
iucn_clean <- iucn_statut %>%
dplyr::mutate(scientificName = stringr::str_trim(scientificName))
species_list_spaces <- gsub("_", " ", species_list)
matched_species <- dplyr::inner_join(
tibble::tibble(species = species_list_spaces),
iucn_clean,
by = c("species" = "scientificName")
)
species_to_update <- tibble::tibble(species = species_list_spaces) %>%
dplyr::anti_join(iucn_clean, by = c("species" = "scientificName"))
synonyms_info <- rfishbase::synonyms(
species_list = species_to_update$species,
server       = "fishbase",
version      = "latest",
fields       = NULL
)
synonyms_info_filtered <- synonyms_info %>%
dplyr::filter(!Status %in% c("misapplied name", "ambiguous synonym", "provisionally accepted name"))
synonyms_mapping <- synonyms_info_filtered %>%
dplyr::select(Species, synonym) %>%
dplyr::distinct()
iucn_clean <- iucn_clean %>%
dplyr::mutate(
scientificName = dplyr::if_else(
scientificName %in% synonyms_mapping$Species,
synonyms_mapping$synonym[match(scientificName, synonyms_mapping$Species)],
scientificName
)
)
matched_species <- dplyr::inner_join(
tibble::tibble(species = species_list_spaces),
iucn_clean,
by = c("species" = "scientificName")
)
species_to_update <- tibble::tibble(species = species_list_spaces) %>%
dplyr::anti_join(iucn_clean, by = c("species" = "scientificName")) %>%
as.data.frame()
rownames(species_to_update) <- species_to_update$species
# Manual corrections (pre-checked)
species_to_check <- read.csv(
"dataOriginal/species_to_update_900_done.csv",
sep = ";",
header = TRUE,
stringsAsFactors = FALSE
)
colnames(species_to_check) <- c("scientificName", "redlistCategory")
iucn_clean <- iucn_clean[, c("scientificName", "redlistCategory")]
acronyms <- c(
"Critically Endangered" = "CR",
"Endangered"            = "EN",
"Vulnerable"            = "VU",
"Near Threatened"       = "NT",
"Least Concern"         = "LC",
"Data Deficient"        = "DD",
"Extinct"               = "EX",
"Extinct in the Wild"   = "EW",
"Not Evaluated"         = "NE"
)
iucn_clean <- iucn_clean %>%
dplyr::mutate(redlistCategory = dplyr::recode(redlistCategory, !!!acronyms)) %>%
dplyr::bind_rows(species_to_check) %>%
dplyr::filter(scientificName %in% species_list_spaces) %>%
dplyr::group_by(scientificName) %>%
dplyr::slice(1) %>%
dplyr::ungroup()
traitsAndPCOA$species <- gsub("_", " ", traitsAndPCOA$species)
traitsAndPCOA$IUCN <- iucn_clean$redlistCategory[
match(traitsAndPCOA$species, iucn_clean$scientificName)
]
# write.table(traitsAndPCOA, "dataPrepared/Fish/traitsWithPCOAIUCN.txt")
traitsAndPCOAIUCN <- read.table(
"dataPrepared/Fish/traitsWithPCOAIUCN.txt",
header = TRUE,
stringsAsFactors = FALSE
)
taxInfo <- pbapply::pblapply(traitsAndPCOAIUCN$species, function(sp) {
tryCatch({
traitdataform::get_gbif_taxonomy(
sp,
subspecies       = TRUE,
higherrank       = TRUE,
conf_threshold   = 80,
resolve_synonyms = FALSE
)[1, ]
}, error = function(e) NULL)
}) %>%
data.table::rbindlist(fill = TRUE)
fishTraitsPhylogenyIUCN <- data.table::data.table(traitsAndPCOAIUCN)
# write.table(fishTraitsPhylogenyIUCN, "dataPrepared/Fish/AllDataFish_clean.txt")
fishData <- read.table(
"dataPrepared/Fish/traitsWithPCOAIUCN.txt",
header = TRUE,
stringsAsFactors = FALSE
)
# Columns for traits and imputation
columnsTraits     <- 2:(which(colnames(fishData) == "Eigen.1") - 1)
columnsImputation <- 2:(which(colnames(fishData) == "IUCN") - 1)
# recommended
fishData_imputed_forest <- read.table(
"dataPrepared/Fish/fishData_imputed_forest.txt",
header = TRUE
)
selectedTraits <- c(
"EdHd", "EhBd", "JlHd", "MoBd", "BlBd", "HdBd",
"PFiBd", "PFlBl", "CFdCPd", "Length", "Weight"
)
newTraitNames <- c(
"es", "ep", "ms", "mp", "elo", "wid",
"pp", "ps", "cs", "svl", "bm"
)
fishTraitsMissing <- fishData[, selectedTraits]
colnames(fishTraitsMissing) <- newTraitNames
rownames(fishTraitsMissing) <- fishData$species
fishTraitsImputed <- fishData_imputed_forest[, selectedTraits]
colnames(fishTraitsImputed) <- newTraitNames
rownames(fishTraitsImputed) <- fishData$species
# Add IUCN
fishTraitsMissing <- data.frame(fishTraitsMissing, IUCN = fishData$IUCN)
fishTraitsImputed <- data.frame(fishTraitsImputed, IUCN = fishData$IUCN)
results   <- readRDS("output/All_fish.rds")
pca_trait <- results$PCA
tpd_trait <- results$TPDs
pca_trait <- readRDS("output/PCA_fish.rds")
tpd_trait <- readRDS("output/TPDs_fish.rds")
fishOtherInfo <- fishData[, (max(columnsTraits) + 1):ncol(fishData)]
df_scraping <- readRDS("output/fish_human_uses_binary_FB.rds") %>%
data.table::as.data.table()
df_uni <- data.table::fread("data/uni.csv")
data.table::setnames(
df_scraping,
c("species_name", "aquarium", "fisheries", "bait", "game_fish", "aquaculture"),
c("Species", "Aquarium", "Fisheries", "Bait", "Game_fish", "Aquaculture")
)
data.table::setnames(df_uni, "Game fish", "Game_fish", skip_absent = TRUE)
binary_cols <- c("Fisheries", "Aquaculture", "Aquarium", "Game_fish", "Bait")
merged_df <- merge(
df_uni,
df_scraping[, c("Species", binary_cols), with = FALSE],
by = "Species",
suffixes = c("", ".scraping"),
all.x = TRUE
)
for (col in binary_cols) {
col_scraping <- paste0(col, ".scraping")
if (col_scraping %in% colnames(merged_df)) {
merged_df[[col]] <- pmax(
as.numeric(merged_df[[col]]),
as.numeric(merged_df[[col_scraping]]),
na.rm = TRUE
)
merged_df[[col_scraping]] <- NULL
}
}
merged_df[, All_uses := as.integer(Fisheries + Aquaculture + Aquarium + Game_fish + Bait > 0)]
merged_df_clean <- merged_df %>%
dplyr::select(Species, dplyr::all_of(binary_cols), All_uses) %>%
dplyr::rename("Game fish" = Game_fish, "All uses" = All_uses)
usage_cols <- c("Fisheries", "Aquaculture", "Aquarium", "Game fish", "Bait", "All uses")
uses_df <- as.data.frame(merged_df_clean[, c("Species", usage_cols), with = FALSE])
uses_df <- uses_df[!is.na(uses_df$Species) & uses_df$Species != "NA", ]
rownames(uses_df) <- uses_df$Species
uses_df$Species <- NULL
df_scraping <- readRDS("output/fish_human_uses_binary_FB.rds") %>%
data.table::as.data.table()
df_uni <- data.table::fread("data/uni.csv")
df_uni <- data.table::fread("dataPrepared/Fish/uni.csv")
data.table::setnames(
df_scraping,
c("species_name", "aquarium", "fisheries", "bait", "game_fish", "aquaculture"),
c("Species", "Aquarium", "Fisheries", "Bait", "Game_fish", "Aquaculture")
)
data.table::setnames(df_uni, "Game fish", "Game_fish", skip_absent = TRUE)
binary_cols <- c("Fisheries", "Aquaculture", "Aquarium", "Game_fish", "Bait")
merged_df <- merge(
df_uni,
df_scraping[, c("Species", binary_cols), with = FALSE],
by = "Species",
suffixes = c("", ".scraping"),
all.x = TRUE
)
for (col in binary_cols) {
col_scraping <- paste0(col, ".scraping")
if (col_scraping %in% colnames(merged_df)) {
merged_df[[col]] <- pmax(
as.numeric(merged_df[[col]]),
as.numeric(merged_df[[col_scraping]]),
na.rm = TRUE
)
merged_df[[col_scraping]] <- NULL
}
}
merged_df[, All_uses := as.integer(Fisheries + Aquaculture + Aquarium + Game_fish + Bait > 0)]
merged_df_clean <- merged_df %>%
dplyr::select(Species, dplyr::all_of(binary_cols), All_uses) %>%
dplyr::rename("Game fish" = Game_fish, "All uses" = All_uses)
usage_cols <- c("Fisheries", "Aquaculture", "Aquarium", "Game fish", "Bait", "All uses")
uses_df <- as.data.frame(merged_df_clean[, c("Species", usage_cols), with = FALSE])
uses_df <- uses_df[!is.na(uses_df$Species) & uses_df$Species != "NA", ]
rownames(uses_df) <- uses_df$Species
uses_df$Species <- NULL
# Manual fix for a mismatched name
uses_df["Centromochlus musaica", ] <- list(
Fisheries = 0,
Aquaculture = 0,
Aquarium = 1,
`Game fish` = 0,
Bait = 0,
`All uses` = 1
)
species_pca   <- rownames(pca_trait$traits_scores)
species_uses  <- rownames(uses_df)
species_ref   <- intersect(species_pca, species_uses)
pca_trait$uses <- uses_df[species_ref, usage_cols, drop = FALSE]
use <- pca_trait$uses
# saveRDS(pca_trait, "output/pca_trait.rds")
pca_trait <- readRDS("output/pca_trait.rds")
species_scores <- as.data.frame(pca_trait$traits_scores[, 1:4])
species_uses   <- as.data.frame(pca_trait$uses)
species_uses$rownames   <- rownames(species_uses)
species_scores$rownames <- rownames(species_scores)
species_scores_uses <- merge(species_uses, species_scores, by = "rownames")
rownames(species_scores_uses) <- species_scores_uses$rownames
species_scores_uses$rownames  <- NULL
species_uses$rownames         <- NULL
MatriceFish <- t(as.matrix(species_uses))
column_names <- rownames(species_uses)
MatriceFish_1 <- matrix(1, nrow = 1, ncol = length(column_names))
colnames(MatriceFish_1) <- column_names
rownames(MatriceFish_1) <- "all"
MatriceFish <- rbind(MatriceFish, MatriceFish_1)
pca_trait   <- readRDS("output/pca_trait.rds")
uni         <- readRDS("output/uni.rds")
dist        <- readRDS("output/dist.rds")
iucn        <- read.table("dataPrepared/Fish/traitsWithPCOAIUCN.txt", header = TRUE)
species_uses <- pca_trait$uses %>%
as.data.frame() %>%
tibble::rownames_to_column("species")
tab <- uni %>%
left_join(species_uses, by = "species") %>%
left_join(iucn %>% select(species, IUCN), by = "species") %>%
mutate(`Non use` =
if_else(Fisheries + Aquaculture + Aquarium + `Game fish` + Bait == 0, 1, 0))
uni_long <- tab %>%
rename(Species = species) %>%
pivot_longer(
c(Fisheries, Aquaculture, Aquarium, `Game fish`, Bait),
names_to = "Use",
values_to = "Use_presence"
) %>%
mutate(
Use         = if_else(`Non use` == 1 & Use == "Fisheries", "Non use", Use),
Use_presence= if_else(Use == "Non use", 1, Use_presence)
) %>%
distinct(Species, Use, .keep_all = TRUE)
tab2 <- dist %>%
left_join(species_uses, by = "species") %>%
left_join(iucn %>% select(species, IUCN), by = "species") %>%
mutate(`Non use` =
if_else(Fisheries + Aquaculture + Aquarium + `Game fish` + Bait == 0, 1, 0))
dist_long <- tab2 %>%
rename(Species = species) %>%
pivot_longer(
c(Fisheries, Aquaculture, Aquarium, `Game fish`, Bait),
names_to = "Use",
values_to = "Use_presence"
) %>%
mutate(
Use         = if_else(`Non use` == 1 & Use == "Fisheries", "Non use", Use),
Use_presence= if_else(Use == "Non use", 1, Use_presence)
) %>%
distinct(Species, Use, .keep_all = TRUE)
df_ui   <- bootstrap_used_proportions_var(uni_long,   var_name = "Ui")
df_dist <- bootstrap_used_proportions_var(dist_long, var_name = "Dist")
p_dist <- plot_proportions_var(df_dist, dist_long, var_name = "Dist")
dist_counts <- get_used_species_var(dist_long, "Dist") %>%
assign_deciles_var(var_name = "Dist") %>%
count(Decile)
dist_species <- get_used_species_var(dist_long, var_name = "Dist") %>%
assign_deciles_var(var_name = "Dist")
global_p <- mean(dist_species$Used)
decile_stats <- dist_species %>%
group_by(Decile) %>%
summarise(
n_total = n(),
n_used  = sum(Used),
prop    = n_used / n_total,
.groups = "drop"
) %>%
mutate(
prop_pct    = prop * 100,
p_value_raw = map2_dbl(n_used, n_total,
~ binom.test(.x, .y, p = global_p)$p.value),
ses         = (prop - global_p) /
sqrt(global_p * (1 - global_p) / n_total),
p_value     = sprintf("%.3f", p_value_raw)
) %>%
select(Decile, n_total, n_used, prop, prop_pct, ses, p_value)
print(decile_stats)
species_dist <- get_used_species_var(dist_long, var_name = "Dist")
glm_dist_use <- glm(Used ~ Dist, data = species_dist, family = binomial)
summary(glm_dist_use)
species_dist$Used <- as.numeric(species_dist$Used)
coef_info <- summary(glm_dist_use)$coefficients
slope     <- coef_info["Dist", "Estimate"]
pval      <- coef_info["Dist", "Pr(>|z|)"]
pseudo_r2 <- pR2(glm_dist_use)["McFadden"]
label_stats <- paste0(
"β = ", sprintf("%.3f", slope),
" | p = ", format.pval(pval, digits = 3, eps = .001)
)
p_dist <- ggplot(species_dist, aes(x = Dist, y = Used)) +
geom_jitter(
aes(color = Dist),
width = 0, height = 0.05, size = 2, alpha = 0.6
) +
geom_smooth(
method      = "glm",
method.args = list(family = "binomial"),
se          = TRUE,
color       = "#2B6CB0",
fill        = "#2B6CB0",
alpha       = 0.25,
linewidth   = 1.2
) +
scale_color_viridis_c(option = "D", begin = 0.85, end = 0.2,
name = "Distinctiveness") +
scale_y_continuous("Probability of being used",
limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
scale_x_continuous("Morphological distinctiveness") +
annotate(
"text", x = Inf, y = 0.1, label = label_stats,
hjust = 1.05, vjust = -0.3, size = 4.5, color = "black"
) +
theme_minimal(base_size = 12)
p_dist
okabe_ito <- c(
"Fisheries"   = "#E69F00",
"Aquaculture" = "#56B4E9",
"Aquarium"    = "#009E73",
"Game fish"   = "#D55E00",
"All uses"    = "#7E1E9C"
)
make_usage_plot <- function(data, usage_name) {
data_use <- data %>%
filter(Use == usage_name) %>%
mutate(Used = Use_presence)
model <- glm(Used ~ Dist, data = data_use, family = binomial)
coef_info <- summary(model)$coefficients
slope <- coef_info["Dist", "Estimate"]
pval  <- coef_info["Dist", "Pr(>|z|)"]
label_stats <- paste0(
"β = ", sprintf("%.3f", slope),
" | p = ", format.pval(pval, digits = 2, eps = .001)
)
ggplot(data_use, aes(x = Dist, y = Used)) +
geom_jitter(
width = 0, height = 0.05, size = 1.5, alpha = 0.6,
color = okabe_ito[[usage_name]]
) +
geom_smooth(
method      = "glm",
method.args = list(family = "binomial"),
se          = TRUE,
linewidth   = 1.1,
color       = okabe_ito[[usage_name]],
fill        = okabe_ito[[usage_name]],
alpha       = 0.25
) +
scale_y_continuous("Probability of being used", limits = c(0, 1)) +
scale_x_continuous("Morphological distinctiveness") +
annotate(
"text", x = Inf, y = 0.8, label = label_stats,
hjust = 1.05, vjust = -0.3, size = 3, color = "black"
) +
ggtitle(usage_name) +
theme_minimal(base_size = 12)
}
make_all_use_plot <- function(data) {
species_dist <- data %>%
group_by(Species) %>%
summarise(
Dist = first(Dist),
Used = as.numeric(any(Use != "Non use" & Use_presence == 1)),
.groups = "drop"
)
model <- glm(Used ~ Dist, data = species_dist, family = binomial)
coef_info <- summary(model)$coefficients
slope <- coef_info["Dist", "Estimate"]
pval  <- coef_info["Dist", "Pr(>|z|)"]
label_stats <- paste0(
"β = ", sprintf("%.3f", slope),
" | p = ", format.pval(pval, digits = 2, eps = .001)
)
ggplot(species_dist, aes(x = Dist, y = Used)) +
geom_jitter(
width = 0, height = 0.05, size = 1.5, alpha = 0.6,
color = okabe_ito[["All uses"]]
) +
geom_smooth(
method      = "glm",
method.args = list(family = "binomial"),
se          = TRUE,
color       = okabe_ito[["All uses"]],
fill        = okabe_ito[["All uses"]],
alpha       = 0.25,
linewidth   = 1.2
) +
scale_y_continuous("Probability of being used", limits = c(0, 1)) +
scale_x_continuous("Morphological distinctiveness") +
annotate(
"text", x = Inf, y = 0.1, label = label_stats,
hjust = 1.05, vjust = -0.3, size = 4.5, color = "black"
) +
ggtitle("All uses") +
theme_minimal(base_size = 12)
}
plot_glm_all_and_usages <- function(data, usage_vector) {
p_all   <- make_all_use_plot(data)
p_uses  <- map(usage_vector, ~make_usage_plot(data, .x))
p_comb  <- wrap_plots(p_uses, ncol = 2)
(p_all | p_comb) + plot_layout(widths = c(1.1, 1))
}
usages_to_plot <- c("Fisheries", "Aquaculture", "Aquarium", "Game fish")
fig_out <- plot_glm_all_and_usages(dist_long, usages_to_plot)
plot_glm_all_and_usages <- function(data, usage_vector) {
p_all   <- make_all_use_plot(data)
p_uses  <- map(usage_vector, ~make_usage_plot(data, .x))
p_comb  <- wrap_plots(p_uses, ncol = 2)
(p_all | p_comb) + plot_layout(widths = c(1.1, 1))
}
usages_to_plot <- c("Fisheries", "Aquaculture", "Aquarium", "Game fish")
fig_out <- plot_glm_all_and_usages(dist_long, usages_to_plot)
fig_out
